<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">
	<service verb="create" noun="ReleasedProduct" authenticate="anonymous-all" allow-remote="false">
		<in-parameters>
			<parameter name="pseudoId" required="true" />
			<parameter name="productName" required="true" />
			<parameter name="provider" required="true" default-value="开通金融信息服务有限公司" />
			<parameter name="productType" required="true" />
			<parameter name="publisher" required="true" />
			<parameter name="publisherTradingCertificate" required="true" />
			<parameter name="publisherBank" required="true" />
			<parameter name="province" required="true" />
			<parameter name="city" required="true" />
			<parameter name="publisherBranchBank" required="true" />
			<parameter name="publisherBankAccount" required="true" />
			<parameter name="riskInstruction" required="true" />
			<parameter name="earningInstruction" required="true" />
			<parameter name="description" required="true" />
			<parameter name="riskEvaluation" required="true" />
			<parameter name="riskRating" required="false" />
			<parameter name="numberOfDays" required="true" />
			<parameter name="daysOfYear" required="true" />
			<parameter name="interestDate" required="true" />
			<parameter name="maturityDate" required="true"/>
			<parameter name="revenueType" required="true" />
			<parameter name="fixedYieldRate" />
			<parameter name="floatingYieldRate" />
			<parameter name="totalAmountToRaise" required="true" />
			<parameter name="minAmountToRaise" required="true" />
			<parameter name="minimumMoney" required="true" />
			<parameter name="perMoney" required="true" />
			<parameter name="startTime" required="true"/>
			<parameter name="endTime" required="true"/>
			<parameter name="remark" />
			<parameter name="payBankAccount" required="true" />
			<parameter name="productCategoryName" required="true" />
			<parameter name="exchangeCode" required="true" />
			<parameter name="productRangeNumber" required="true" />
			<parameter name="projectCode" required="true" />
			<parameter name="versionNo" required="true" />
		</in-parameters>
		<out-parameters>
		</out-parameters>
		<actions>
			<service-call name="create#ReleasedProduct" out-map="context" in-map="context" />
			<if condition="ec.message.hasError()">
				<then>
					<message error="true">创建失败</message>
				</then>
				<else>
					<message>创建成功</message>
				</else>
			</if>
		</actions>
	</service>
	<service verb="update" noun="ReleasedProduct" authenticate="anonymous-all" allow-remote="false">
		<in-parameters>
			<parameter name="productId" required="true" />
			<parameter name="pseudoId" required="true" />
			<parameter name="productName" required="true" />
			<parameter name="provider" required="true" default-value="开通金融信息服务有限公司" />
			<parameter name="productType" required="true" />
			<parameter name="publisher" required="true" />
			<parameter name="publisherTradingCertificate" required="true" />
			<parameter name="publisherBank" required="true" />
			<parameter name="province" required="true" />
			<parameter name="city" required="true" />
			<parameter name="publisherBranchBank" required="true" />
			<parameter name="publisherBankAccount" required="true" />
			<parameter name="riskInstruction" required="true" />
			<parameter name="earningInstruction" required="true" />
			<parameter name="description" required="true" />
			<parameter name="riskEvaluation" required="true" />
			<parameter name="riskRating" required="false" />
			<parameter name="numberOfDays" required="true" />
			<parameter name="daysOfYear" required="true" />
			<parameter name="interestDate" required="true" format="yyyyMMdd" />
			<parameter name="maturityDate" required="true" format="yyyyMMdd" />
			<parameter name="revenueType" required="true" />
			<parameter name="fixedYieldRate" />
			<parameter name="floatingYieldRate" />
			<parameter name="totalAmountToRaise" required="true" />
			<parameter name="minAmountToRaise" required="true" />
			<parameter name="minimumMoney" required="true" />
			<parameter name="perMoney" required="true" />
			<parameter name="startTime" required="true" format="yyyyMMdd HH:mm:ss" />
			<parameter name="endTime" required="true" format="yyyyMMdd HH:mm:ss" />
			<parameter name="remark" />
			<parameter name="payBankAccount" required="true" />
			<parameter name="productCategoryName" required="true" />
			<parameter name="exchangeCode" required="true" />
			<parameter name="productRangeNumber" required="true" />
			<parameter name="projectCode" required="true" />
			<parameter name="versionNo" required="true" />
		</in-parameters>
		<out-parameters>
		</out-parameters>
		<actions>
			<service-call name="update#ReleasedProduct" out-map="context" in-map="context" />
			<if condition="ec.message.hasError()">
				<then>
					<message error="true">修改失败</message>
				</then>
				<else>
					<message>修改成功</message>
				</else>
			</if>
		</actions>
	</service>
	<service verb="select" noun="ReleasedProduct" authenticate="anonymous-all" allow-remote="false">
		<in-parameters>
			<parameter name="productId" required="true" />
		</in-parameters>
		<out-parameters>
		</out-parameters>
		<actions>
			<!-- <service-call name="update#ReleasedProduct" out-map="context" in-map="context" /> -->
			<entity-find-one value-field="product" entity-name="ReleasedProduct">
				<field-map field-name="productId" />
			</entity-find-one>
		</actions>
	</service>
	<service verb="sendToSFTP" noun="ReleasedProduct" authenticate="anonymous-all" allow-remote="false" type="inline">
		<in-parameters>
			<parameter name="productId" required="true" />
		</in-parameters>
		<out-parameters>
		</out-parameters>
		<actions>
			<entity-find-one value-field="product" entity-name="ReleasedProduct">
				<field-map field-name="productId" />
			</entity-find-one>
			<entity-find-one value-field="provence" entity-name="moqui.basic.Geo">
				<field-map field-name="geoId" from="product.province" />
			</entity-find-one>
			
			<entity-find-one value-field="city" entity-name="moqui.basic.Geo">
				<field-map field-name="geoId" from="product.city" />
			</entity-find-one>
			
 			<script><![CDATA[
				import com.finance.utils.SFTPParameter
				import com.finance.utils.SftpUtil
                import org.moqui.context.ExecutionContext
                
                
                
				SFTPParameter para = new SFTPParameter();

				para.hostName = "127.0.0.1";
				para.userName = "sunmingjun";
				para.passWord = "sunmingjun";
				para.port = 22;
				
				ExecutionContext ec = context.ec
				interestDate=ec.l10n.format(product.interestDate, "yyyyMMdd")
				maturityDate=ec.l10n.format(product.maturityDate, "yyyyMMdd")
				startTime=ec.l10n.format(product.startTime, "yyyyMMdd HH:mm:ss")
				endTime=ec.l10n.format(product.endTime, "yyyyMMdd HH:mm:ss")
				
				def riskRating=product.riskRating
				if(null==product.riskRating){
				riskRating=""
				}
				def remark=product.remark
				if(null==product.remark){
				remark=""
				}
				
				
				header="产品提供方|产品名称|产品类型|发行方|发行方营业执照|发行方开户银行|所属省|所属市|发行方开户分支行|发行方银行账号|"
                header=header+"产品风险说明|产品收益说明|产品描述|是否需要风险测评|产品风险等级|产品期限（天）|年化天数|起息日|到期日|收益类型|固定年化收益率|"
                header=header+"浮动年化收益率|募集总金额|子包最低募集成功金额|起售金额|单位加价金额|上架时间|下架时间|备注|打款银行账户名称|大包产品名称|交易所代码|产品系列编号"
				productString="|"+product.provider+"|"+product.productName+"|"+product.productType+"|"+product.publisher+"|"+product.publisherTradingCertificate
				productString=productString+"|"+product.publisherBank+"|"+provence.geoNameLocal+"|"+city.geoNameLocal+"|"+product.publisherBranchBank+"|"+product.publisherBankAccount+"|"+product.riskInstruction
				productString=productString+"|"+product.earningInstruction+"|"+product.description+"|"+product.riskEvaluation+"|"+riskRating+"|"+product.numberOfDays+"|"+product.daysOfYear
				productString=productString+"|"+interestDate+"|"+maturityDate+"|"+product.revenueType+"|"+product.fixedYieldRate+"|"+product.floatingYieldRate+"|"+product.totalAmountToRaise
				productString=productString+"|"+product.minAmountToRaise+"|"+product.minimumMoney+"|"+product.perMoney+"|"+startTime+"|"+endTime+"|"+remark+"|"+product.payBankAccount+"|"+product.productCategoryName+"|"+product.exchangeCode+"|"+product.productRangeNumber
			    content=header+productString
			    
			    path="D:/upload/"
			    fileName=product.projectCode+"_产品发布文件_"+product.versionNo+".txt"
                File testFile = new File(path+fileName)
                testFile.createNewFile()
                FileOutputStream fos = new FileOutputStream(testFile)
                org.apache.commons.io.IOUtils.write(content.getBytes(), fos)


				String makeDir = "/home/hezuo/"
				SftpUtil.makeDir(para, makeDir)
				
				para.uploadPath =makeDir
                SftpUtil.uploadFile(para, testFile)
            ]]>
			</script>
			<if condition="ec.message.hasError()">
				<then>
					<message error="true">发送失败</message>
				</then>
				<else>
					<message>发送成功</message>
				</else>
			</if>
		</actions>
	</service>
</services>